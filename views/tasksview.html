<!DOCTYPE html>
<html>
    <head>
        <title>jQuery.Gantt</title>
		<meta charset="utf-8">
      <script src="javascripts/jquery-3.6.1.min.js"></script>
      <script src="javascripts/dhtmlxgantt.js" ></script>
      <link rel="stylesheet" href="stylesheets/dhtmlxgantt.css" type="text/css">
    </head>
    <body>
      <div class="gantt_control">
        <button class='zoom_toggle' onclick="toggleMode(this)">Zoom to Fit</button>
        <input type=button value="Zoom In" onclick="zoom_in();">
        <input type=button value="Zoom Out" onclick="zoom_out();">
      </div>
      <div id="gantt_here" style='width:100%; height:calc(100vh - 52px); position: relative;'></div>
    <script>

      function parseDate(str, fmt)
      {
        fmt = fmt || 'yyyy-MM-dd';
        var obj = {y: 0, M: 1, d: 0, H: 0, h: 0, m: 0, s: 0, S: 0};
        fmt.replace(/([^yMdHmsS]*?)(([yMdHmsS])\3*)([^yMdHmsS]*?)/g, function(m, $1, $2, $3, $4, idx, old)
        {
          str = str.replace(new RegExp($1+'(\\d{'+$2.length+'})'+$4), function(_m, _$1)
          {
            obj[$3] = parseInt(_$1);
            return '';
          });
          return '';
        });
        obj.M--; // 月份是从0开始的，所以要减去1
        var date = new Date(obj.y, obj.M, obj.d, obj.H, obj.m, obj.s);
        if(obj.S !== 0) date.setMilliseconds(obj.S); // 如果设置了毫秒
        return date;
      }

      // 指定时间转换为时间戳
      function toTimeStamp(dateString){
        // dateString例如:'2022-03-05'
        // 例如返回:1646611200000
        return parseDate(dateString , 'yyyy年MM月dd日') - 0;
      }

      // 计算两个日期距离的天数
      function getDistanceDays(date1,date2){
        // date1例如:'2022-03-05',date2例如:'2022-03-06'
        const date1_timeStamp = toTimeStamp(date1)
        const date2_timeStamp = toTimeStamp(date2)
        let max = '', min = ''
        if(date1_timeStamp>date2_timeStamp){
          max = date1_timeStamp
          min = date2_timeStamp
        }else{
          max = date2_timeStamp
          min = date1_timeStamp
        }
        // 例如返回:'1'
        return (max-min)/(24*60*60*1000)
      }

      function toggleMode(toggle) {
        gantt.$zoomToFit = !gantt.$zoomToFit;
        if (gantt.$zoomToFit) {
          toggle.innerHTML = "Set default Scale";
          //Saving previous scale state for future restore
          saveConfig();
          zoomToFit();
        } else {

          toggle.innerHTML = "Zoom to Fit";
          //Restore previous scale state
          restoreConfig();
          gantt.render();
        }
      }

      var cachedSettings = {};

      function saveConfig() {
        var config = gantt.config;
        cachedSettings = {};
        cachedSettings.scales = config.scales;
        cachedSettings.start_date = config.start_date;
        cachedSettings.end_date = config.end_date;
        cachedSettings.scroll_position = gantt.getScrollState();
      }

      function restoreConfig() {
        applyConfig(cachedSettings);
      }

      function applyConfig(config, dates) {

        gantt.config.scales = config.scales;

        // restore the previous scroll position
        if (config.scroll_position) {
          setTimeout(function(){
            gantt.scrollTo(config.scroll_position.x, config.scroll_position.y)
          },4)
        }
      }


      function zoomToFit() {
        var project = gantt.getSubtaskDates(),
          areaWidth = gantt.$task.offsetWidth,
          scaleConfigs = zoomConfig.levels;

        for (var i = 0; i < scaleConfigs.length; i++) {
          var columnCount = getUnitsBetween(project.start_date, project.end_date, scaleConfigs[i].scales[scaleConfigs[i].scales.length-1].unit, scaleConfigs[i].scales[0].step);
          if ((columnCount + 2) * gantt.config.min_column_width <= areaWidth) {
            break;
          }
        }


        if (i == scaleConfigs.length) {
          i--;
        }

        gantt.ext.zoom.setLevel(scaleConfigs[i].name);
        applyConfig(scaleConfigs[i], project);
      }

      // get number of columns in timeline
      function getUnitsBetween(from, to, unit, step) {
        var start = new Date(from),
          end = new Date(to);
        var units = 0;
        while (start.valueOf() < end.valueOf()) {
          units++;
          start = gantt.date.add(start, step, unit);
        }
        return units;
      }

      function zoom_in(){
        gantt.ext.zoom.zoomIn();
        gantt.$zoomToFit = false;
        document.querySelector(".zoom_toggle").innerHTML = "Zoom to Fit";
      }
      function zoom_out(){
        gantt.ext.zoom.zoomOut();
        gantt.$zoomToFit = false;
        document.querySelector(".zoom_toggle").innerHTML = "Zoom to Fit";
      }

      var zoomConfig = {
        levels: [
          // hours
          {
            name:"hour",
            scale_height: 27,
            scales:[
              {unit:"day", step: 1, format:"%d %M"},
              {unit:"hour", step: 1, format:"%H:%i"},
            ]
          },
          // days
          {
            name:"day",
            scale_height: 27,
            scales:[
              {unit: "day", step: 1, format: "%d %M"}
            ]
          },
          // weeks
          {
            name:"week",
            scale_height: 50,
            scales:[
              {unit: "week", step: 1, format: function (date) {
                var dateToStr = gantt.date.date_to_str("%d %M");
                var endDate = gantt.date.add(date, -6, "day");
                var weekNum = gantt.date.date_to_str("%W")(date);
                return "#" + weekNum + ", " + dateToStr(date) + " - " + dateToStr(endDate);
              }},
              {unit: "day", step: 1, format: "%j %D"}
            ]
          },
          // months
          {
            name:"month",
            scale_height: 50,
            scales:[
              {unit: "month", step: 1, format: "%F, %Y"},
              {unit: "week", step: 1, format: function (date) {
                var dateToStr = gantt.date.date_to_str("%d %M");
                var endDate = gantt.date.add(gantt.date.add(date, 1, "week"), -1, "day");
                return dateToStr(date) + " - " + dateToStr(endDate);
              }}
            ]
          },
          // quarters
          {
            name:"quarter",
            height: 50,
            scales:[
              {
                unit: "quarter", step: 3, format: function (date) {
                  var dateToStr = gantt.date.date_to_str("%M %y");
                  var endDate = gantt.date.add(gantt.date.add(date, 3, "month"), -1, "day");
                  return dateToStr(date) + " - " + dateToStr(endDate);
                }
              },
              {unit: "month", step: 1, format: "%M"},
            ]
          },
          // years
          {
            name:"year",
            scale_height: 50,
            scales:[
              {unit: "year", step: 5, format: function (date) {
                var dateToStr = gantt.date.date_to_str("%Y");
                var endDate = gantt.date.add(gantt.date.add(date, 5, "year"), -1, "day");
                return dateToStr(date) + " - " + dateToStr(endDate);
              }}
            ]
          },
          // decades
          {
            name:"year",
            scale_height: 50,
            scales:[
              {unit: "year", step: 100, format: function (date) {
                var dateToStr = gantt.date.date_to_str("%Y");
                var endDate = gantt.date.add(gantt.date.add(date, 100, "year"), -1, "day");
                return dateToStr(date) + " - " + dateToStr(endDate);
              }},
              {unit: "year", step: 10, format: function (date) {
                var dateToStr = gantt.date.date_to_str("%Y");
                var endDate = gantt.date.add(gantt.date.add(date, 10, "year"), -1, "day");
                return dateToStr(date) + " - " + dateToStr(endDate);
              }},
            ]
          },
        ],
        element: function(){
          return gantt.$root.querySelector(".gantt_task");
        }
      };

      gantt.config.fit_tasks = true;


      gantt.ext.zoom.init(zoomConfig);

      gantt.ext.zoom.setLevel("day");

      gantt.$zoomToFit = false;

      gantt.config.date_format = "%Y-%m-%d %H:%i";
      gantt.init("gantt_here");

      $.getJSON('/getdata.do?type=tasks', {}, function(config) {
          var tasks = [];
          for(var i=0 ;i < config.data.length; i ++)
          {
            var row = config.data[i];
            var item = {};
            item.text       = row.task;
            item.start_date = row.starttime;
            item.end_date   = row.endtime;
            item.duration   = getDistanceDays(row.endtime,row.starttime);
            tasks.push(item);
          }

          gantt.parse({data:tasks});

      });

    </script>

  </body>
</html>